<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Bitácora Canguro</title>
    
    <script>
        const isAuthenticated = localStorage.getItem('isAuthenticated');
        if (isAuthenticated !== 'true') {
            // Si no está autenticado, redirigir a la página de login
            window.location.href = 'login.html';
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'canguro-yellow': '#FFC107', 
                        'canguro-dark': '#333333',
                    },
                    fontFamily: {
                        sans: ['sans-serif'], 
                    }
                }
            }
        }
    </script>

    <style>
        /* INICIO: ESTILOS PARA LA FACHADA DE FONDO */
        body {
            background-image: url('Fachada.png'); 
            background-color: #f7f7f7; 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* Aplicar un fondo semi-transparente a los contenedores principales para mejorar la legibilidad */
        .chart-box, .content-card {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
        }

        .metric-card {
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        /* Estilo para el nuevo encabezado (Top Bar) */
        .top-bar {
            background-color: rgba(51, 51, 51, 0.9); /* Fondo oscuro semitransparente */
            padding: 1rem 0; /* Relleno superior e inferior */
            width: 100%;
            position: sticky; /* Fija la barra arriba */
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* FIN: ESTILOS PARA LA FACHADA DE FONDO */

        .chart-box canvas { 
            height: 300px !important; 
        }
        
        .table-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            overflow-x: auto;
        }
        
        #tablaDesconexion thead {
            background-color: #333333;
            color: white;
        }
        
        #tablaDesconexion tbody tr:nth-child(even) {
            background-color: #f4f4f4;
        }
        
        /* Estilo para fila de alerta de alto promedio - Usando color de marca original */
        .alert-row td {
            background-color: #FFC107 !important; 
            color: #333333 !important; 
            font-weight: bold; 
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="max-w-6xl mx-auto flex justify-between items-center px-4 sm:px-6 lg:px-8 relative">
            
            <div class="flex-grow flex justify-center">
                <img 
                    src="logo-canguro.png" 
                    alt="Logo Canguro" 
                    class="w-auto h-20"
                    onerror="this.onerror=null; this.src='https://placehold.co/120x60/FFC107/333333?text=LOGO';"
                />
            </div>

            <div class="absolute right-4 sm:right-6 lg:right-8 top-1/2 -translate-y-1/2 flex items-center space-x-3">
                <p class="text-white text-sm hidden sm:block">
                    Bienvenido, <strong id="currentUser"></strong>
                </p>
                <button 
                    onclick="logout()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg 
                           shadow-lg text-sm transition duration-300"
                >
                    Cerrar sesión
                </button>
            </div>
        </div>
    </div>
    
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 pt-4">

        <header class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6 p-4 content-card border-b-2 border-canguro-yellow text-center">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard Bitácora</h1>
            <p class="text-base text-gray-500 hidden sm:block">| Análisis de Conectividad Biométrico</p>
        </header>

        <div class="flex flex-wrap items-center justify-center gap-4 mb-6 p-4 content-card">
            <div class="flex items-center gap-2">
                <label for="mesSelect" class="text-sm text-gray-700">Seleccionar Mes:</label>
                <select id="mesSelect" class="p-2 border border-gray-300 rounded-md shadow-sm"></select>
            </div>

            <div class="flex items-center gap-2">
                <label for="tipoSelect" class="text-sm text-gray-700">Agrupar por:</label>
                <select id="tipoSelect" class="p-2 border border-gray-300 rounded-md shadow-sm">
                    <option value="lineal">Lineal (por fecha)</option>
                    <option value="semana">Semana</option>
                    <option value="trimestre">Trimestre</option>
                    <option value="global">Global (Meses)</option>
                </select>
            </div>
        </div>
        
        <div id="indicadoresDiv" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            </div>

        <div class="chart-box p-4 mb-8 w-full lg:max-w-5xl mx-auto">
            <h2 class="text-xl font-bold mb-4 text-center text-gray-800 border-b pb-2">Sedes Únicas por Región y Estado</h2>
            <canvas id="graficoRegion"></canvas>
        </div>

        <div class="flex flex-wrap justify-center gap-6">
            <div class="chart-box p-4 w-full lg:w-[48%] max-w-lg">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-800 border-b pb-2">Tendencia de Desconexiones</h2>
                <canvas id="graficoFechas"></canvas>
            </div>
            <div class="chart-box p-4 w-full lg:w-[48%] max-w-lg">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-800 border-b pb-2">Distribución de Estado de Conexión</h2>
                <canvas id="graficoEstado"></canvas>
            </div>
        </div>

        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-3 text-center text-gray-800">Top 10 Sedes por Mayor Desconexión</h2>
            <div class="text-center mb-4">
                <label for="estadoFiltro" class="text-sm text-gray-700 mr-2">Filtrar por estado:</label>
                <select id="estadoFiltro" class="p-2 border border-gray-300 rounded-md shadow-sm">
                    <option value="todos">Todos</option>
                    <option value="en linea">En línea</option>
                    <option value="sin conexion">Sin conexión</option>
                </select>
            </div>
            
            <div class="table-container content-card p-3">
                <table id="tablaDesconexion" class="w-full text-sm text-gray-600 rounded-md overflow-hidden">
                    <thead class="shadow-md">
                        <tr>
                            <th class="p-3 text-left">Sede</th>
                            <th class="p-3 text-center">Prom. Cantidad</th>
                            <th class="p-3 text-center">Total Desconexión</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div> <script>
        // Función para cerrar la sesión
        function logout() {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Mostrar usuario actual al cargar
        document.getElementById('currentUser').textContent = localStorage.getItem('user') || 'Invitado';

        // --- CÓDIGO JAVASCRIPT DEL DASHBOARD (COMIENZA AQUÍ) ---
        let allRows = [];
        let chartFechas;
        let chartEstado;
        let chartRegion;

        /** Mapeo de nombres de meses en español a números para orden cronológico. */
        const monthOrder = {
            "enero": 1, "febrero": 2, "marzo": 3, "abril": 4, "mayo": 5, "junio": 6,
            "julio": 7, "agosto": 8, "septiembre": 9, "octubre": 10, "noviembre": 11, "diciembre": 12
        };

        /**
         * Convierte el formato de fecha serial de Google Sheets (Epoch 1899-12-30) a un objeto Date de JS.
         */
        function sheetDateToJSDate(serial) {
            const epoch = new Date(1899, 11, 30);
            return new Date(epoch.getTime() + serial * 86400000);
        }

        /**
         * Obtiene el objeto Date a partir del valor serial.
         */
        function getDateObject(val) {
            if (!val || isNaN(Number(val))) return null;
            return sheetDateToJSDate(Number(val));
        }

        /**
         * Formatea segundos totales a HH:MM:SS.
         */
        function formatSecondsToHms(totalSegundos) {
            const total = Math.round(totalSegundos);
            const hh = Math.floor(total / 3600);
            const mm = Math.floor((total % 3600) / 60);
            const ss = total % 60;
            return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}:${String(ss).padStart(2, "0")}`;
        }

        /**
         * Carga los datos iniciales y configura los selectores.
         */
        async function loadData() {
            try {
                // NOTA: Este fetch debe ser resuelto por el entorno del servidor
                const res = await fetch("/data"); 
                const json = await res.json();
                allRows = json.rows;
                if (!allRows || allRows.length <= 1) {
                    console.error("No se encontraron datos o el formato es incorrecto.");
                    document.getElementById("indicadoresDiv").innerHTML = `
                        <p class="col-span-2 text-center text-lg text-red-500 bg-red-100 p-4 rounded-lg">
                            ⚠️ Error: No se pudieron cargar los datos o el archivo está vacío.
                        </p>
                    `;
                    return;
                }

                // Obtener meses únicos (Columna I, índice 8)
                const rows = allRows.slice(1);
                const meses = [...new Set(
                    rows.map(r => (r[8] || "").trim().toLowerCase()).filter(m => m)
                )].sort((a, b) => {
                    const orderA = monthOrder[a];
                    const orderB = monthOrder[b];
                    if (orderA && orderB) { return orderA - orderB; }
                    return a.localeCompare(b);
                });

                const mesSelect = document.getElementById("mesSelect");
                mesSelect.innerHTML = "";

                // Añadir opción "Global"
                const optionGlobal = document.createElement("option");
                optionGlobal.value = "global";
                optionGlobal.textContent = "Global (Todos los Meses)";
                mesSelect.appendChild(optionGlobal);
                
                // Añadir meses al selector
                meses.forEach(m => {
                    const option = document.createElement("option");
                    option.value = m;
                    option.textContent = m.charAt(0).toUpperCase() + m.slice(1);
                    mesSelect.appendChild(option);
                });

                // Event listeners
                const tipoSelect = document.getElementById("tipoSelect");
                const estadoFiltro = document.getElementById("estadoFiltro");

                const handleFilterChange = () => {
                    const selectedMes = mesSelect.value;
                    const selectedTipo = tipoSelect.value;
                    
                    // Forzar a "global" si la agrupación es "global"
                    if (selectedTipo === "global" && selectedMes !== "global") {
                        mesSelect.value = "global";
                    }

                    renderChart(mesSelect.value, tipoSelect.value);
                };

                mesSelect.addEventListener("change", handleFilterChange);
                tipoSelect.addEventListener("change", handleFilterChange);
                estadoFiltro.addEventListener("change", handleFilterChange);

                // Renderizado inicial con la opción Global por defecto
                renderChart("global", "lineal");

            } catch (error) {
                console.error("Error al cargar los datos:", error);
            }
        }

        /**
         * Renderiza el dashboard completo (gráficos y tabla) basado en los filtros.
         */
        function renderChart(mesSeleccionado, tipoAgrupacion) {
            const rows = allRows.slice(1);
            
            const isGlobalView = tipoAgrupacion === "global" || mesSeleccionado === "global";
            const filteredRows = isGlobalView
                ? rows
                : rows.filter(r => (r[8] || "").trim().toLowerCase() === mesSeleccionado.trim().toLowerCase());

            const finalTipoAgrupacion = isGlobalView ? "mes" : tipoAgrupacion;
            
            // --- 1. Gráfico de desconexiones por periodo (graficoFechas) ---
            const ctxFechas = document.getElementById("graficoFechas").getContext("2d");
            if (chartFechas) chartFechas.destroy();

            const dataFechas = {};
            filteredRows.forEach(r => {
                const d = getDateObject(r[0]);
                if (!d) return;
                const cantidad = parseInt(r[10]) || 0; 
                const dt = luxon.DateTime.fromJSDate(d);
                let key;

                if (finalTipoAgrupacion === "mes") key = (r[8] || "").trim().toLowerCase();
                else if (finalTipoAgrupacion === "lineal") key = dt.toISODate();
                else if (finalTipoAgrupacion === "semana") key = `Semana ${dt.weekNumber}`;
                else if (finalTipoAgrupacion === "trimestre") key = `Q${Math.ceil(dt.month / 3)}`;
                
                if (!key) return;
                dataFechas[key] = (dataFechas[key] || 0) + cantidad;
            });

            const labelsFechas = Object.keys(dataFechas).sort((a, b) => {
                if (finalTipoAgrupacion === "lineal") return new Date(a) - new Date(b);
                if (finalTipoAgrupacion === "mes") {
                    return monthOrder[a] - monthOrder[b];
                }
                return a.localeCompare(b);
            });
            
            chartFechas = new Chart(ctxFechas, {
                type: "bar",
                data: {
                    labels: labelsFechas,
                    datasets: [{
                        label: `Total de Desconexión (${finalTipoAgrupacion.charAt(0).toUpperCase() + finalTipoAgrupacion.slice(1)})`,
                        data: labelsFechas.map(l => dataFechas[l]),
                        backgroundColor: "#FFC107", 
                        borderColor: "#FBBF24", 
                        borderWidth: 1, 
                        fill: false,
                        tension: 0.1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: "Cantidad de Eventos" } },
                        x: { title: { display: true, text: finalTipoAgrupacion.charAt(0).toUpperCase() + finalTipoAgrupacion.slice(1) } }
                    },
                    plugins: {
                        legend: { position: "top" },
                        datalabels: { 
                            display: true, 
                            color: '#333333', 
                            anchor: 'end',
                            align: 'top',
                            offset: 4, 
                            formatter: (value) => value.toLocaleString(),
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // --- 2. Gráfico de región (graficoRegion) ---
            const ctxRegion = document.getElementById("graficoRegion").getContext("2d");
            if (chartRegion) chartRegion.destroy();

            const regiones = {};
            const uniqueEnLinea = new Set();
            const uniqueSinConexion = new Set();
            
            filteredRows.forEach(r => {
                const region = (r[7] || "").trim(); 
                const sede = (r[1] || "").trim(); 
                const estado = (r[9] || "").trim().toLowerCase(); 

                if (!region || !sede) return;
                
                if (!regiones[region]) regiones[region] = { enLinea: new Set(), sinConexion: new Set() };
                if (estado === "en linea") regiones[region].enLinea.add(sede);
                else if (estado === "sin conexion") regiones[region].sinConexion.add(sede);
                
                if (estado === "en linea") uniqueEnLinea.add(sede);
                else if (estado === "sin conexion") uniqueSinConexion.add(sede);
            });

            const regionLabels = Object.keys(regiones).sort();
            chartRegion = new Chart(ctxRegion, {
                type: "bar", 
                data: {
                    labels: regionLabels,
                    datasets: [
                        {
                            label: "Sedes Sin Conexión Únicas",
                            data: regionLabels.map(r => regiones[r].sinConexion.size),
                            backgroundColor: "#333333", 
                            borderColor: "#222222",
                            borderWidth: 1,
                        },
                        {
                            label: "Sedes En Línea Únicas",
                            data: regionLabels.map(r => regiones[r].enLinea.size),
                            backgroundColor: "#FFC107", 
                            borderColor: "#FBBF24",
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, title: { display: true, text: "Región" } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: "Cantidad de Sedes únicas" } },
                    },
                    plugins: {
                        legend: { position: "bottom" },
                        datalabels: {
                            color: function(ctx) {
                                if (ctx.datasetIndex === 0) return '#fff'; 
                                return '#333333'; 
                            },
                            formatter: function(value) { return value > 0 ? value : ''; },
                            anchor: 'center', 
                            align: 'center',
                            font: { weight: 'bold', size: 10 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // --- 3. Gráfico de estado (graficoEstado) y Cálculo de KPIs ---
            const ctxEstado = document.getElementById("graficoEstado").getContext("2d");
            if (chartEstado) chartEstado.destroy();

            const totalSedes = new Set([...uniqueEnLinea, ...uniqueSinConexion]).size;

            const countEnLinea = uniqueEnLinea.size;
            const countSinConexion = uniqueSinConexion.size;
            
            const promEnLinea = totalSedes > 0 ? ((countEnLinea / totalSedes) * 100).toFixed(1) : 0;
            const promSinConexion = totalSedes > 0 ? ((countSinConexion / totalSedes) * 100).toFixed(1) : 0;
            
            renderKpis(promEnLinea, countEnLinea, promSinConexion, countSinConexion);

            chartEstado = new Chart(ctxEstado, {
                type: "pie",
                data: {
                    labels: [`En línea (${countEnLinea})`, `Sin conexión (${countSinConexion})`],
                    datasets: [{
                        data: [countEnLinea, countSinConexion],
                        backgroundColor: ["#FFC107", "#333333"], 
                        hoverBackgroundColor: ["#FBBF24", "#444444"]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "bottom" },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} (${percent}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#ffffff', 
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${value}\n(${percent}%)`;
                            },
                            font: { weight: 'bold', size: 12 },
                            align: 'center',
                            anchor: 'center',
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // --- 4. Renderizar Tabla ---
            renderTablaPorFiltro(mesSeleccionado);
        }

        /**
         * Renderiza las tarjetas de indicadores (KPIs).
         */
        function renderKpis(promEnLinea, countEnLinea, promSinConexion, countSinConexion) {
            const indicadoresDiv = document.getElementById("indicadoresDiv");
            indicadoresDiv.innerHTML = `
                <div class="metric-card bg-green-500 text-white flex items-center justify-between">
                    <div>
                        <p class="text-sm">Promedio de Sedes En Línea</p>
                        <p class="text-3xl font-bold mt-1">${promEnLinea}% - ${countEnLinea} sedes</p>
                        <p class="text-xs mt-1">(Basado en registros únicos)</p>
                    </div>
                    <span class="text-3xl">✅</span>
                </div>

                <div class="metric-card bg-red-500 text-white flex items-center justify-between">
                    <div>
                        <p class="text-sm">Promedio de Sedes Sin Conexión</p>
                        <p class="text-3xl font-bold mt-1">${promSinConexion}% - ${countSinConexion} sedes</p>
                        <p class="text-xs mt-1">(Basado en registros únicos)</p>
                    </div>
                    <span class="text-3xl">❌</span>
                </div>
            `;
        }

        /**
         * Renderiza la tabla de Top Sedes filtrada por mes y estado.
         */
        function renderTablaPorFiltro(mesSeleccionado) {
            const estadoSeleccionado = document.getElementById("estadoFiltro").value.trim().toLowerCase();
            const rows = allRows.slice(1);

            // 1. Filtrar por mes (Columna I, índice 8)
            const filteredByMonth = mesSeleccionado === "global"
                ? rows
                : rows.filter(r => (r[8] || "").trim().toLowerCase() === mesSeleccionado.trim().toLowerCase());

            // 2. Aplicar filtro por estado (Columna J, índice 9)
            const finalFilteredRows = filteredByMonth.filter(r => {
                const estado = (r[9] || "").trim().toLowerCase(); 
                return estadoSeleccionado === "todos" || estado === estadoSeleccionado;
            });

            // 3. Agrupar por sede
            const sedes = {};
            finalFilteredRows.forEach(r => {
                const sede = (r[1] || "").trim(); 
                const cantidad = parseInt(r[10]) || 0; 
                const tiempo = (r[6] || "").trim(); 

                if (!sede || sede === "" || !tiempo || !tiempo.includes(":")) return; 

                if (!sedes[sede]) sedes[sede] = { totalCantidad: 0, count: 0, totalSegundos: 0 };

                sedes[sede].totalCantidad += cantidad;
                sedes[sede].count += 1;

                // Sumar tiempo total de desconexión (convertir HH:MM:SS a segundos)
                const parts = tiempo.split(":");
                if (parts.length === 3) {
                    const [hh, mm, ss] = parts.map(Number);
                    sedes[sede].totalSegundos += (hh * 3600) + (mm * 60) + ss;
                }
            });

            // 4. Procesar y ordenar
            const tablaBody = document.querySelector("#tablaDesconexion tbody");
            tablaBody.innerHTML = "";

            const sedesOrdenadas = Object.entries(sedes)
                .map(([sede, datos]) => {
                    const prom = datos.count > 0 ? Math.round(datos.totalCantidad / datos.count) : 0;
                    const totalSegundos = datos.totalSegundos;
                    const tiempoStr = formatSecondsToHms(totalSegundos);
                    
                    return { sede, prom, tiempoStr, totalSegundos }; 
                })
                .sort((a, b) => {
                    // Criterio 1: Ordenar por Prom. Cantidad (mayor a menor)
                    if (b.prom !== a.prom) {
                        return b.prom - a.prom; 
                    }
                    // Criterio 2: Si el promedio es igual, ordenar por Tiempo Total de Desconexión (mayor a menor)
                    return b.totalSegundos - a.totalSegundos;
                });

            // 5. Renderizar: Top 10
            sedesOrdenadas.slice(0, 10).forEach(({ sede, prom, tiempoStr }, index) => {
                const fila = document.createElement("tr");
                
                // Estilo visual de alerta si el promedio de cantidad es alto (>= 10)
                const isTopProm = prom >= 10;
                
                fila.className = isTopProm ? 'alert-row' : (index % 2 === 0 ? 'bg-white' : 'bg-f4f4f4');

                const promClasses = isTopProm ? 'bg-canguro-yellow text-gray-900 font-bold' : 'text-gray-800';
                
                fila.innerHTML = `
                    <td class="p-3 text-left">${sede}</td>
                    <td class="p-3 text-center ${promClasses}">${prom}</td>
                    <td class="p-3 text-center text-gray-800">${tiempoStr}</td>
                `;
                tablaBody.appendChild(fila);
            });
            
            if (sedesOrdenadas.length === 0) {
                 tablaBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="p-4 text-center text-gray-500 italic">No hay datos disponibles para los filtros seleccionados.</td>
                    </tr>
                `;
            }
        }

        // Inicialización
        document.addEventListener("DOMContentLoaded", loadData);
    </script>
</body>
</html>